from typing import Optional
from sqlalchemy.orm import Session, joinedload
from sqlalchemy import or_, and_
from uuid import UUID
from fastapi import HTTPException 

from app.models.livraison import Livraison
from app.models.commande import Commande
from app.models.client import Client
# from app.models.avis import Avis
from app.models.marchand import Marchand
from app.models.notification import TypeNotification
from app.schemas.livraison import LivraisonCreate, LivraisonStatutUpdate, ProblemeSignalement
from app.schemas.notification import NotificationCreate
from app.services.notification import creer_notification


class LivraisonService:

    @staticmethod
    def creer_livraison(db: Session, livraison_data: LivraisonCreate):
        livraison = Livraison(**livraison_data.dict())
        db.add(livraison)
        db.commit()
        db.refresh(livraison)
        
        # âœ… RÃ©cupÃ©ration du marchand via la commande
        commande = db.query(Commande).filter(Commande.id == livraison.commande_id).first()
        if not commande:
            raise HTTPException(status_code=404, detail="Commande introuvable")
        
        # Notification au marchand
        notif = NotificationCreate(
            user_id=commande.marchand_id,
            user_type="marchand",
            titre="Nouvelle livraison crÃ©Ã©e",
            message="Une nouvelle demande de livraison a Ã©tÃ© enregistrÃ©e.",
            type=TypeNotification.info
        )
        creer_notification(db, notif)
        return livraison

    @staticmethod
    def obtenir_livraison(db: Session, livraison_id: UUID):
        return db.query(Livraison).filter(Livraison.id == livraison_id).first()
    
    @staticmethod
    def obtenir_livraisons(db: Session):
        return db.query(Livraison).all()

    @staticmethod
    def accepter_livraison(db: Session, livraison_id: UUID, livreur_id: UUID):
        livraison = db.query(Livraison).filter(Livraison.id == livraison_id).first()
        if not livraison:
            raise HTTPException(status_code=404, detail="Livraison introuvable")
        livraison.livreur_id = livreur_id
        livraison.statut = "acceptee"
        db.commit()
        db.refresh(livraison)
        
        # âœ… RÃ©cupÃ©ration du marchand via la commande
        commande = db.query(Commande).filter(Commande.id == livraison.commande_id).first()
        if not commande:
            raise HTTPException(status_code=404, detail="Commande introuvable")
        
        
        
        # ðŸ”” Marchand
        notif_marchand = NotificationCreate(
            user_id=commande.marchand_id,
            user_type="marchand",
            titre="Livraison acceptÃ©e",
            message="Un livreur a acceptÃ© la livraison.",
            type=TypeNotification.success
        )
        creer_notification(db, notif_marchand)

        # ðŸ”” Client
        notif_client = NotificationCreate(
            user_id=commande.client_id,
            user_type="client",
            titre="Livreur assignÃ©",
            message="Un livreur a acceptÃ© la livraison.",
            type=TypeNotification.info
        )
        creer_notification(db, notif_client)

        # ðŸ”” Livreur
        notif_livreur = NotificationCreate(
            user_id=livreur_id,
            user_type="livreur",
            titre="Nouvelle livraison",
            message="Vous avez acceptÃ© une nouvelle livraison.",
            type=TypeNotification.info
        )
        creer_notification(db, notif_livreur)

        # âœ… Retour avec message personnalisÃ©
        return {
            "message": "Livraison acceptÃ©e avec succÃ¨s.",
            "livraison": livraison
        }

    @staticmethod
    def terminer_livraison(db: Session, livraison_id: UUID):
        livraison = db.query(Livraison).filter(Livraison.id == livraison_id).first()
        if not livraison:
            raise HTTPException(status_code=404, detail="Livraison introuvable")
        livraison.statut = "terminee"
        db.commit()
        db.refresh(livraison)
        
        
        # âœ… RÃ©cupÃ©ration du marchand via la commande
        commande = db.query(Commande).filter(Commande.id == livraison.commande_id).first()
        if not commande:
            raise HTTPException(status_code=404, detail="Commande introuvable")
        
        # ðŸ”” Client
        notif_client = NotificationCreate(
            user_id=commande.client_id,
            user_type="client",
            titre="Livraison terminÃ©e",
            message="Votre livraison a Ã©tÃ© finalisÃ©e avec succÃ¨s.",
            type=TypeNotification.success
        )
        creer_notification(db, notif_client)

        # ðŸ”” Marchand
        notif_marchand = NotificationCreate(
            user_id=commande.marchand_id,
            user_type="marchand",
            titre="Livraison terminÃ©e",
            message="Une de vos livraisons vient d'Ãªtre terminÃ©e.",
            type=TypeNotification.info
        )
        creer_notification(db, notif_marchand)

        # ðŸ”” Livreur
        notif_livreur = NotificationCreate(
            user_id=livraison.livreur_id,
            user_type="livreur",
            titre="Livraison finalisÃ©e",
            message="Vous avez terminÃ© une livraison.",
            type=TypeNotification.info
        )
        creer_notification(db, notif_livreur)
        return livraison

    @staticmethod
    def annuler_livraison(db: Session, livraison_id: UUID):
        livraison = db.query(Livraison).filter(Livraison.id == livraison_id).first()
        if not livraison:
            raise HTTPException(status_code=404, detail="Livraison introuvable")
        livraison.statut = "annulee"
        db.commit()
        db.refresh(livraison)
        
        
        # âœ… RÃ©cupÃ©ration du marchand via la commande
        commande = db.query(Commande).filter(Commande.id == livraison.commande_id).first()
        if not commande:
            raise HTTPException(status_code=404, detail="Commande introuvable")
        
        # ðŸ”” Client
        notif_client = NotificationCreate(
            user_id=commande.client_id,
            user_type="client",
            titre="Livraison annulÃ©e",
            message="Votre livraison a Ã©tÃ© annulÃ©e.",
            type=TypeNotification.warning
        )
        creer_notification(db, notif_client)

        # ðŸ”” Marchand
        notif_marchand = NotificationCreate(
            user_id=commande.marchand_id,
            user_type="marchand",
            titre="Livraison annulÃ©e",
            message="Une de vos livraisons a Ã©tÃ© annulÃ©e.",
            type=TypeNotification.warning
        )
        creer_notification(db, notif_marchand)

        # ðŸ”” Livreur
        if livraison.livreur_id:
            notif_livreur = NotificationCreate(
                user_id=livraison.livreur_id,
                user_type="livreur",
                titre="Livraison annulÃ©e",
                message="Une livraison Ã  laquelle vous Ã©tiez affectÃ© a Ã©tÃ© annulÃ©e.",
                type=TypeNotification.warning
            )
            creer_notification(db, notif_livreur)
        return {
            "message": "Livraison a Ã©tÃ© annulÃ©e avec succÃ¨s.",
            "livraison": livraison
        }

    @staticmethod
    def voir_historique_livraisons(db: Session, livreur_id: UUID):
        return db.query(Livraison).filter(Livraison.livreur_id == livreur_id).all()

    @staticmethod
    def rechercher_livraisons(db: Session, mot_cle: str):
        return db.query(Livraison).filter(
            or_(
                Livraison.statut.ilike(f"%{mot_cle}%"),
                # Livraison.url_suivi.ilike(f"%{mot_cle}%"),
                Livraison.type_livraison.ilike(f"%{mot_cle}%")
            )
        ).all()

    # @staticmethod
    # def voir_avis_client(db: Session, livraison_id: UUID):
    #     return db.query(Avis).filter(Avis.livraison_id == livraison_id).all()

    @staticmethod
    def voir_details_commande(db: Session, commande_id: UUID):
        return db.query(Commande).filter(Commande.id == commande_id).first()

    # @staticmethod
    # def livraisons_disponibles_par_localisation(db: Session, ville: str):
    #     return db.query(Livraison).filter(and_(
    #         Livraison.ville == ville,
    #         Livraison.statut == "en_attente",
    #         Livraison.livreur_id == None
    #     )).all()
        
    @staticmethod
    def livraisons_disponibles(db: Session):
        return db.query(Livraison).filter(and_(
            Livraison.statut == "en_attente",
            # Livraison.livreur_id == None
        )).all()

    @staticmethod
    def mettre_a_jour_statut(db: Session, livraison_id: UUID, update_data: LivraisonStatutUpdate):
        livraison = db.query(Livraison).filter(Livraison.id == livraison_id).first()
        if not livraison:
            raise HTTPException(status_code=404, detail="Livraison introuvable")
        livraison.statut = update_data.nouveau_statut
        db.commit()
        db.refresh(livraison)
        return livraison

    @staticmethod
    def demarrer_livraison(db: Session, livraison_id: UUID):
        livraison = db.query(Livraison).filter(Livraison.id == livraison_id).first()
        if not livraison:
            raise HTTPException(status_code=404, detail="Livraison introuvable")
        livraison.statut = "en_cours"
        db.commit()
        db.refresh(livraison)
        
        # âœ… RÃ©cupÃ©ration du marchand via la commande
        commande = db.query(Commande).filter(Commande.id == livraison.commande_id).first()
        if not commande:
            raise HTTPException(status_code=404, detail="Commande introuvable")
        
         # ðŸ”” Client
        notif_client = NotificationCreate(
            user_id=commande.client_id,
            user_type="client",
            titre="Livraison en cours",
            message="Votre livraison est actuellement en cours.",
            type=TypeNotification.info
        )
        creer_notification(db, notif_client)

        # ðŸ”” Marchand
        notif_marchand = NotificationCreate(
            user_id=commande.marchand_id,
            user_type="marchand",
            titre="Livraison dÃ©marrÃ©e",
            message="Une livraison a Ã©tÃ© dÃ©marrÃ©e.",
            type=TypeNotification.info
        )
        creer_notification(db, notif_marchand)

        # ðŸ”” Livreur
        notif_livreur = NotificationCreate(
            user_id=livraison.livreur_id,
            user_type="livreur",
            titre="Livraison en cours",
            message="Vous avez dÃ©marrÃ© une livraison.",
            type=TypeNotification.info
        )
        creer_notification(db, notif_livreur)
        return livraison

    @staticmethod
    def signaler_probleme(db: Session, livraison_id: UUID, data: ProblemeSignalement):
        livraison = db.query(Livraison).filter(Livraison.id == livraison_id).first()
        if not livraison:
            raise HTTPException(status_code=404, detail="Livraison introuvable")
        livraison.probleme = data.description
        # livraison.statut = "probleme"
        db.commit()
        db.refresh(livraison)
        
        # âœ… RÃ©cupÃ©ration du marchand via la commande
        commande = db.query(Commande).filter(Commande.id == livraison.commande_id).first()
        if not commande:
            raise HTTPException(status_code=404, detail="Commande introuvable")
        
        # ðŸ”” Client
        notif_client = NotificationCreate(
            user_id=commande.client_id,
            user_type="client",
            titre="ProblÃ¨me signalÃ©",
            message="Un problÃ¨me a Ã©tÃ© dÃ©tectÃ© durant votre livraison.",
            type=TypeNotification.error
        )
        creer_notification(db, notif_client)

        # ðŸ”” Marchand
        notif_marchand = NotificationCreate(
            user_id=commande.marchand_id,
            user_type="marchand",
            titre="ProblÃ¨me signalÃ©",
            message="Un problÃ¨me a Ã©tÃ© signalÃ© lors de la livraison.",
            type=TypeNotification.error
        )
        creer_notification(db, notif_marchand)

        # ðŸ”” Livreur
        if livraison.livreur_id:
            notif_livreur = NotificationCreate(
                user_id=livraison.livreur_id,
                user_type="livreur",
                titre="ProblÃ¨me signalÃ©",
                message="Un problÃ¨me a Ã©tÃ© signalÃ© sur une livraison que vous effectuez.",
                type=TypeNotification.error
            )
            creer_notification(db, notif_livreur)
            return {"message": "votre signalement a Ã©tÃ© pris en compte."}

    @staticmethod
    def supprimer_livraison(db: Session, livraison_id: UUID):
        livraison = db.query(Livraison).filter(Livraison.id == livraison_id).first()
        if not livraison:
            raise HTTPException(status_code=404, detail="Livraison introuvable")
        
        # âœ… RÃ©cupÃ©ration du marchand via la commande
        commande = db.query(Commande).filter(Commande.id == livraison.commande_id).first()
        if not commande:
            raise HTTPException(status_code=404, detail="Commande introuvable")
        
        notif = NotificationCreate(
            user_id=commande.marchand_id,
            user_type="marchand",
            titre="Livraison supprimÃ©e",
            message="Une livraison a Ã©tÃ© supprimÃ©e.",
            type=TypeNotification.warning
        )
        creer_notification(db, notif)
    
        db.delete(livraison)
        db.commit()
        return {"message": "Livraison supprimÃ©e avec succÃ¨s"}
    
    
    @staticmethod
    def get_livraisons_par_utilisateur(db: Session, utilisateur_id: UUID, statut: Optional[str] = None):
        """RÃ©cupÃ¨re toutes les livraisons des marchands d'un utilisateur"""
        # RÃ©cupÃ¨re les marchands de l'utilisateur
        marchands = db.query(Marchand).filter(Marchand.utilisateur_id == utilisateur_id).all()
        
        if not marchands:
            return []
        
        marchand_ids = [m.id for m in marchands]
        
        query = db.query(Livraison).join(Commande).filter(
            Commande.marchand_id.in_(marchand_ids)
        ).options(
            joinedload(Livraison.commande),
            joinedload(Livraison.livreur)
        )
        
        if statut:
            query = query.filter(Livraison.statut == statut)
            
        return query.order_by(Livraison.date_livraison.desc()).all()
    
    @staticmethod
    def get_livraisons_marchand(db: Session, marchand_id: UUID, statut: Optional[str] = None):
        """RÃ©cupÃ¨re les livraisons d'un marchand avec les donnÃ©es jointes"""
        query = db.query(Livraison).join(Commande).filter(
            Commande.marchand_id == marchand_id
        ).options(
            joinedload(Livraison.commande),
            joinedload(Livraison.livreur)
            # joinedload(Livraison.client)
        )
        
        if statut:
            query = query.filter(Livraison.statut == statut)
            
        return query.order_by(Livraison.date_livraison.desc()).all()

    @staticmethod
    def get_livraisons_livreur(db: Session, livreur_id: UUID, statut: Optional[str] = None):
        """RÃ©cupÃ¨re les livraisons d'un livreur avec les donnÃ©es jointes"""
        query = db.query(Livraison).filter(
            Livraison.livreur_id == livreur_id
        ).options(
            joinedload(Livraison.commande),
            joinedload(Livraison.livreur)
        )
        
        if statut:
            query = query.filter(Livraison.statut == statut)
            
        return query.order_by(Livraison.date_livraison.desc()).all()

    @staticmethod
    def get_livraisons_client(db: Session, client_id: UUID, statut: Optional[str] = None):
        """RÃ©cupÃ¨re les livraisons d'un client avec les donnÃ©es jointes"""
        query = db.query(Livraison).join(Commande).filter(
            Commande.client_id == client_id
        ).options(
            joinedload(Livraison.commande),
            joinedload(Livraison.livreur)
        )
        
        if statut:
            query = query.filter(Livraison.statut == statut)
            
        return query.order_by(Livraison.date_livraison.desc()).all()

    @staticmethod
    def get_livraison_with_details(db: Session, livraison_id: UUID):
        """RÃ©cupÃ¨re une livraison avec tous les dÃ©tails"""
        return db.query(Livraison).filter(
            Livraison.id == livraison_id
        ).options(
            joinedload(Livraison.commande),
            joinedload(Livraison.livreur)
        ).first()

